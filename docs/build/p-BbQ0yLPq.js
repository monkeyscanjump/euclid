import{a as e,f as t}from"./p-uEsOKkhe.js";import{l as s}from"./p-b11lwN92.js";const n=(e,t,s)=>{const n=e.get(t);if(!n){e.set(t,[s])}else if(!n.includes(s)){n.push(s)}};const r=(e,t)=>{let s;return(...n)=>{if(s){clearTimeout(s)}s=setTimeout((()=>{s=0;e(...n)}),t)}};const o=e=>!("isConnected"in e)||e.isConnected;const a=r((e=>{for(let t of e.keys()){e.set(t,e.get(t).filter(o))}}),2e3);const i=()=>{if(typeof e!=="function"){return{}}const s=new Map;return{dispose:()=>s.clear(),get:t=>{const r=e();if(r){n(s,t,r)}},set:e=>{const n=s.get(e);if(n){s.set(e,n.filter(t))}a(s)},reset:()=>{s.forEach((e=>e.forEach(t)));a(s)}}};const c=e=>typeof e==="function"?e():e;const u=(e,t=(e,t)=>e!==t)=>{const s=c(e);let n=new Map(Object.entries(s??{}));const r={dispose:[],get:[],set:[],reset:[]};const o=new Map;const a=()=>{n=new Map(Object.entries(c(e)??{}));r.reset.forEach((e=>e()))};const i=()=>{r.dispose.forEach((e=>e()));a()};const u=e=>{r.get.forEach((t=>t(e)));return n.get(e)};const l=(e,s)=>{const o=n.get(e);if(t(s,o,e)){n.set(e,s);r.set.forEach((t=>t(e,s,o)))}};const f=typeof Proxy==="undefined"?{}:new Proxy(s,{get(e,t){return u(t)},ownKeys(e){return Array.from(n.keys())},getOwnPropertyDescriptor(){return{enumerable:true,configurable:true}},has(e,t){return n.has(t)},set(e,t,s){l(t,s);return true}});const p=(e,t)=>{r[e].push(t);return()=>{d(r[e],t)}};const h=(t,s)=>{const n=(e,n)=>{if(e===t){s(n)}};const r=()=>s(c(e)[t]);const a=p("set",n);const i=p("reset",r);o.set(s,{setHandler:n,resetHandler:r,propName:t});return()=>{a();i();o.delete(s)}};const g=(...e)=>{const t=e.reduce(((e,t)=>{if(t.set){e.push(p("set",t.set))}if(t.get){e.push(p("get",t.get))}if(t.reset){e.push(p("reset",t.reset))}if(t.dispose){e.push(p("dispose",t.dispose))}return e}),[]);return()=>t.forEach((e=>e()))};const y=e=>{const t=n.get(e);r.set.forEach((s=>s(e,t,t)))};const m=(e,t)=>{const s=o.get(t);if(s&&s.propName===e){d(r.set,s.setHandler);d(r.reset,s.resetHandler);o.delete(t)}};return{state:f,get:u,set:l,on:p,onChange:h,use:g,dispose:i,reset:a,forceUpdate:y,removeListener:m}};const d=(e,t)=>{const s=e.indexOf(t);if(s>=0){e[s]=e[e.length-1];e.length--}};const l=(e,t)=>{const s=u(e,t);s.use(i());return s};class f{constructor(){this.pendingUpdates=new Map;this.stateSnapshots=new Map}deepEquals(e,t){if(e===t)return true;if(e===null||t===null||e===undefined||t===undefined){return e===t}if(typeof e!==typeof t)return false;if(typeof e==="object"){if(Array.isArray(e)!==Array.isArray(t))return false;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return false;return e.every(((e,s)=>this.deepEquals(e,t[s])))}const s=Object.keys(e);const n=Object.keys(t);if(s.length!==n.length)return false;return s.every((s=>n.includes(s)&&this.deepEquals(e[s],t[s])))}return false}createChecksum(e){try{const t=JSON.stringify(e,Object.keys(e).sort());let s=0;for(let e=0;e<t.length;e++){const n=t.charCodeAt(e);s=(s<<5)-s+n;s=s&s}return s.toString(36)}catch{return Math.random().toString(36)}}detectChanges(e,t,s){const n=this.stateSnapshots.get(e)||{};const r={};const o=new Set(s.skipFields||[]);for(const[e,a]of Object.entries(t)){if(o.has(e))continue;const t=n[e];const i=s.deepCompare?!this.deepEquals(t,a):t!==a;r[e]={oldValue:t,newValue:a,hasChanged:i}}return r}shouldUpdate(e,t){if(t.forceUpdate)return true;return Object.values(e).some((e=>e.hasChanged))}scheduleUpdate(e,t,s,n={}){const r=this.pendingUpdates.get(e);if(r){clearTimeout(r.timer)}const o={debounceMs:100,deepCompare:true,skipFields:["loading","error","lastUpdated"],...n};if(o.debounceMs===0){this.executeUpdate(e,t,s,o);return}const a=window.setTimeout((()=>{this.executeUpdate(e,t,s,o);this.pendingUpdates.delete(e)}),o.debounceMs);this.pendingUpdates.set(e,{timer:a,updateFn:s,options:o})}executeUpdate(e,t,n,r){const o=t();const a=this.detectChanges(e,o,r);if(this.shouldUpdate(a,r)){s.info("Utils",`ðŸ”„ Store update [${e}]:`,{changedFields:Object.keys(a).filter((e=>a[e].hasChanged)),totalFields:Object.keys(a).length});n();this.stateSnapshots.set(e,{...o})}else{s.info("Utils",`â­ï¸ Store update skipped [${e}]: No significant changes detected`)}}forceUpdate(e,t,s){this.executeUpdate(e,t,s,{forceUpdate:true})}clearPendingUpdates(e){const t=this.pendingUpdates.get(e);if(t){clearTimeout(t.timer);this.pendingUpdates.delete(e)}}clearAllPendingUpdates(){for(const[e]of this.pendingUpdates){this.clearPendingUpdates(e)}}getPendingUpdates(){return Array.from(this.pendingUpdates.keys())}destroy(){this.clearAllPendingUpdates();this.stateSnapshots.clear()}}const p=new f;function h(e,t,s={}){return{...e,smartUpdate:(n,r)=>{const o={...s,...r};p.scheduleUpdate(t,(()=>e.state),(()=>{Object.assign(e.state,n)}),o)},smartSetField:(n,r,o)=>{const a={...s,...o};p.scheduleUpdate(t,(()=>e.state),(()=>{e.state[n]=r}),a)}}}const g={chains:[],tokens:[],pools:[],prices:{},loading:false,error:null,lastUpdated:0,lastChainsUpdate:0,lastTokensUpdate:0};const{state:y,onChange:m,reset:k,dispose:w}=l(g);const U=h({state:y,onChange:m},"market-store",{debounceMs:150,deepCompare:true,skipFields:["loading","error"]});const b={setLoading(e){y.loading=e},setError(e){y.error=e},setChains(e){y.chains=[...e];y.lastChainsUpdate=Date.now();y.lastUpdated=Date.now()},setTokens(e){y.tokens=[...e];y.lastTokensUpdate=Date.now();y.lastUpdated=Date.now()},setPools(e){y.pools=[...e];y.lastUpdated=Date.now()},setPrices(e){y.prices={...e};y.lastUpdated=Date.now()},updateChainsSmartly(e){U.smartUpdate({chains:[...e],lastUpdated:Date.now()})},updateTokensSmartly(e){U.smartUpdate({tokens:[...e],lastUpdated:Date.now()})},updatePoolsSmartly(e){U.smartUpdate({pools:[...e],lastUpdated:Date.now()})},addToken(e){U.smartUpdate({tokens:[...y.tokens,e]},{debounceMs:0})},updateToken(e,t){U.smartUpdate({tokens:y.tokens.map((s=>s.id===e?{...s,...t}:s))},{debounceMs:0})},clear(){k()}};const C={getChain:e=>y.chains.find((t=>t.chain_uid===e)),getToken:e=>y.tokens.find((t=>t.id===e)),getTokensByChain:e=>y.tokens.filter((t=>t.chain_uid===e)),getPool:e=>y.pools.find((t=>t.pool_id===e)),getPoolsForTokenPair:(e,t)=>y.pools.filter((s=>s.token_1===e&&s.token_2===t||s.token_1===t&&s.token_2===e)),getPrice:e=>y.prices[e]||0,isDataStale:(e=5*60*1e3)=>{if(!y.lastUpdated)return true;return Date.now()-y.lastUpdated>e},isChainsStale:(e=5*60*1e3)=>{if(!y.lastChainsUpdate)return true;return Date.now()-y.lastChainsUpdate>e},isTokensStale:(e=5*60*1e3)=>{if(!y.lastTokensUpdate)return true;return Date.now()-y.lastTokensUpdate>e}};const D={state:y,onChange:m,reset:k,dispose:w,...b,...C};if(typeof window!=="undefined"){window.marketStore=D}export{l as c,D as m};
//# sourceMappingURL=p-BbQ0yLPq.js.map