<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
  <title>Euclid Protocol - Component Test Page</title>

  <script type="module" src="/build/euclid.esm.js"></script>
  <script nomodule src="/build/euclid.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .test-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: white;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: #5a67d8;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #test-area {
      min-height: 400px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    #logs {
      background: #1a1a1a;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }

    .log-success { color: #00ff00; }
    .log-error { color: #ff4444; }
    .log-warning { color: #ffaa00; }
    .log-info { color: #00aaff; }
    .log-debug { color: #888; }
  </style>
</head>

<body>
  <div class="container">
    <h1>🚀 Euclid Protocol Components Test</h1>

    <div class="test-controls">
      <button onclick="testPoolsList()">Test Pools List</button>
      <button onclick="testSwapCard()">Test Swap Card</button>
      <button onclick="testLiquidityCard()">Test Liquidity Card</button>
      <button onclick="testPortfolioOverview()">Test Portfolio</button>
      <button onclick="clearLogs()">Clear Logs</button>
      <button onclick="testMarketData()">Test Market Data</button>
    </div>

    <div id="test-area">
      <p>Click a test button above to load components...</p>
    </div>

    <div id="logs"></div>
  </div>

  <!-- Market Data Controller - This loads real Euclid API data -->
  <euclid-market-data-controller></euclid-market-data-controller>

  <script>
    // Global logging system
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;

      const logsContainer = document.getElementById('logs');
      logsContainer.appendChild(logEntry);
      logsContainer.scrollTop = logsContainer.scrollHeight;

      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    function testPoolsList() {
      log('Testing euclid-pools-list component...');
      try {
        const testArea = document.getElementById('test-area');
        testArea.innerHTML = '<h4>Testing Pools List Component:</h4><p>Creating component...</p>';

        const poolsList = document.createElement('euclid-pools-list');
        poolsList.setAttribute('show-search', 'true');
        poolsList.setAttribute('show-filters', 'true');

        // Wait for market data to load completely, checking multiple times if needed
        let attempts = 0;
        const maxAttempts = 10;
        const checkAndSetPools = () => {
          attempts++;

          if (window.marketStore && window.marketStore.state.pools.length > 0) {
            log(`Debug: Attempt ${attempts} - Found ${window.marketStore.state.pools.length} pools`, 'info');
            log(`Debug: Attempt ${attempts} - Found ${window.marketStore.state.tokens.length} tokens`, 'info');

            // Transform PoolInfo[] from API to PoolData[] expected by component
            const transformedPools = window.marketStore.state.pools.map((apiPool) => {
              // Get token metadata for token_1 and token_2
              const tokens = window.marketStore.state.tokens;
              const tokenA = tokens.find(t =>
                t.tokenId === apiPool.token_1 ||
                t.displayName === apiPool.token_1 ||
                (t.tokenId && t.tokenId.toLowerCase() === apiPool.token_1?.toLowerCase()) ||
                (t.displayName && t.displayName.toLowerCase() === apiPool.token_1?.toLowerCase())
              );

              const tokenB = tokens.find(t =>
                t.tokenId === apiPool.token_2 ||
                t.displayName === apiPool.token_2 ||
                (t.tokenId && t.tokenId.toLowerCase() === apiPool.token_2?.toLowerCase()) ||
                (t.displayName && t.displayName.toLowerCase() === apiPool.token_2?.toLowerCase())
              );

              // Create fallback token data if not found in token metadata
              const tokenAData = tokenA || {
                displayName: apiPool.token_1,
                tokenId: apiPool.token_1,
                coinDecimal: 6,
                image: ''
              };

              const tokenBData = tokenB || {
                displayName: apiPool.token_2,
                tokenId: apiPool.token_2,
                coinDecimal: 6,
                image: ''
              };

              return {
                id: apiPool.pool_id,
                address: apiPool.pool_id,
                tokenA: {
                  symbol: tokenAData.displayName || apiPool.token_1,
                  name: tokenAData.displayName || apiPool.token_1,
                  address: tokenAData.tokenId || apiPool.token_1,
                  decimals: tokenAData.coinDecimal || 6,
                  logoUrl: tokenAData.image || ''
                },
                tokenB: {
                  symbol: tokenBData.displayName || apiPool.token_2,
                  name: tokenBData.displayName || apiPool.token_2,
                  address: tokenBData.tokenId || apiPool.token_2,
                  decimals: tokenBData.coinDecimal || 6,
                  logoUrl: tokenBData.image || ''
                },
                reserveA: '0',
                reserveB: '0',
                totalSupply: '0',
                lpTokenSymbol: `${apiPool.token_1}-${apiPool.token_2} LP`,
                fee: 0.3,
                apy: parseFloat(apiPool.apr || '0'),
                apr: parseFloat(apiPool.apr || '0'),
                tvl: parseFloat(apiPool.total_liquidity || '0'),
                volume24h: parseFloat(apiPool.volume_24h || '0'),
                volumeWeek: parseFloat(apiPool.volume_24h || '0') * 7,
                fees24h: parseFloat(apiPool.fees_24h || '0'),
                feesWeek: parseFloat(apiPool.fees_24h || '0') * 7,
                priceChange24h: 0,
                isStakable: false,
                stakingApr: 0
              };
            });

            poolsList.pools = transformedPools;
            log(`✅ Successfully loaded ${transformedPools.length} real Euclid pools with token metadata`, 'success');
            return;
          }

          if (attempts < maxAttempts) {
            log(`Waiting for market data... attempt ${attempts}/${maxAttempts}`, 'info');
            setTimeout(checkAndSetPools, 1000);
          } else {
            log('❌ Timeout waiting for market data to load', 'error');
          }
        };

        setTimeout(checkAndSetPools, 2000);

        testArea.appendChild(poolsList);
        log('euclid-pools-list component created successfully', 'success');

      } catch (error) {
        log(`Pools list test failed: ${error.message}`, 'error');
      }
    }

    function testSwapCard() {
      log('Testing euclid-swap-card component...');
      try {
        const testArea = document.getElementById('test-area');
        testArea.innerHTML = '<h4>Testing Swap Card Component:</h4><p>Creating component...</p>';

        const swapCard = document.createElement('euclid-swap-card');
        swapCard.setAttribute('card-title', 'Real Euclid Swap');
        swapCard.setAttribute('show-advanced', 'true');

        testArea.appendChild(swapCard);
        log('euclid-swap-card component created successfully', 'success');

      } catch (error) {
        log(`Swap card test failed: ${error.message}`, 'error');
      }
    }

    function testLiquidityCard() {
      log('Testing euclid-liquidity-card component...');
      try {
        const testArea = document.getElementById('test-area');
        testArea.innerHTML = '<h4>Testing Liquidity Card Component:</h4><p>Creating component...</p>';

        const liquidityCard = document.createElement('euclid-liquidity-card');
        liquidityCard.setAttribute('card-title', 'Add Liquidity');
        liquidityCard.setAttribute('show-pool-selection', 'true');

        testArea.appendChild(liquidityCard);
        log('euclid-liquidity-card component created successfully', 'success');

      } catch (error) {
        log(`Liquidity card test failed: ${error.message}`, 'error');
      }
    }

    function testPortfolioOverview() {
      log('Testing euclid-portfolio-overview component...');
      try {
        const testArea = document.getElementById('test-area');
        testArea.innerHTML = '<h4>Testing Portfolio Overview Component:</h4><p>Creating component...</p>';

        const portfolio = document.createElement('euclid-portfolio-overview');
        portfolio.setAttribute('show-breakdown', 'true');

        testArea.appendChild(portfolio);
        log('euclid-portfolio-overview component created successfully', 'success');

      } catch (error) {
        log(`Portfolio overview test failed: ${error.message}`, 'error');
      }
    }

    function testMarketData() {
      log('Testing market data store...');

      if (window.marketStore) {
        log('Market store is available', 'success');
        log(`Chains loaded: ${window.marketStore.state.chains.length}`, 'info');
        log(`Tokens loaded: ${window.marketStore.state.tokens.length}`, 'info');
        log(`Pools loaded: ${window.marketStore.state.pools.length}`, 'info');
        log(`Loading state: ${window.marketStore.state.isLoading}`, 'info');

        if (window.marketStore.state.error) {
          log(`Store error: ${window.marketStore.state.error}`, 'error');
        }

      } else {
        log('Market store not available yet', 'warning');
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      log('🎉 Euclid Protocol Components Test Page Loaded');
      log('📡 Market data controller is initializing...');

      setTimeout(() => {
        testMarketData();
      }, 3000);
    });
  </script>
</body>

</html>
