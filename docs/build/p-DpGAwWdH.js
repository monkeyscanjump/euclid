import{D as t}from"./p-9CRWQAc1.js";const s={CONNECT_REQUEST:"euclid:wallet:connect-request",CONNECT_SUCCESS:"euclid:wallet:connect-success",CONNECT_FAILED:"euclid:wallet:connect-failed",DISCONNECT_SUCCESS:"euclid:wallet:disconnect-success"};const e={EXECUTE_REQUEST:"euclid:swap:execute-request",EXECUTE_SUCCESS:"euclid:swap:execute-success",EXECUTE_FAILED:"euclid:swap:execute-failed"};const i={ADD_REQUEST:"euclid:liquidity:add-request",ADD_SUCCESS:"euclid:liquidity:add-success",ADD_FAILED:"euclid:liquidity:add-failed",REMOVE_REQUEST:"euclid:liquidity:remove-request",REMOVE_SUCCESS:"euclid:liquidity:remove-success",REMOVE_FAILED:"euclid:liquidity:remove-failed",POSITIONS_REFRESH:"euclid:liquidity:positions-refresh"};const n={SUBMITTED:"euclid:transaction:submitted",FINALIZED:"euclid:transaction:finalized",TIMEOUT:"euclid:transaction:timeout",TRACK_REQUEST:"euclid:transaction:track-request",STATS_RESPONSE:"euclid:transaction:stats-response"};const a={LOAD_INITIAL:"euclid:market:load-initial",REFRESH_DATA:"euclid:market:refresh-data",TOKEN_DETAILS_REQUEST:"euclid:market:token-details-request",TOKEN_DETAILS_SUCCESS:"euclid:market:token-details-success",TOKEN_DETAILS_FAILED:"euclid:market:token-details-failed",CHAIN_DETAILS_SUCCESS:"euclid:market:chain-details-success",CHAIN_DETAILS_FAILED:"euclid:market:chain-details-failed",ESCROWS_LOADED:"euclid:market:escrows-loaded"};const c={REFRESH_DATA:"euclid:user:refresh-data",CONTROLLER_READY:"euclid:user:controller-ready",BALANCES_REFRESH:"euclid:user:balances-refresh"};const r={TOKEN_SELECTED:"euclid:ui:token-selected"};const o={WALLET:s,SWAP:e,LIQUIDITY:i,TRANSACTION:n,MARKET:a,USER:c,UI:r};function u(t,s){return new CustomEvent(t,{detail:s})}function h(t,s){window.dispatchEvent(u(t,s))}class d{constructor(t={}){this.pendingRequests=new Map;this.cache=new Map;this.config={ttl:3e4,priority:"normal",...t}}async request(t,s,e){const i={...this.config,...e};if(this.pendingRequests.has(t)){return this.pendingRequests.get(t)}const n=this.cache.get(t);if(n&&Date.now()-n.timestamp<i.ttl){return n.data}const a=s();this.pendingRequests.set(t,a);try{const s=await a;this.cache.set(t,{data:s,timestamp:Date.now()});return s}finally{this.pendingRequests.delete(t)}}clearCache(t){this.cache.delete(t)}clearAllCache(){this.cache.clear()}isCached(t,s){const e=this.cache.get(t);if(!e)return false;const i=s||this.config.ttl;return Date.now()-e.timestamp<i}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}}const l=new d;class f{constructor(){this.tasks=new Map;this.isDocumentVisible=true;this.setupVisibilityHandling()}register(t,s,e){this.unregister(t);const i={id:t,fn:s,config:{pauseOnHidden:true,...e},isActive:true};this.tasks.set(t,i);this.startTask(i)}unregister(t){const s=this.tasks.get(t);if(s){this.stopTask(s);this.tasks.delete(t)}}pause(t){const s=this.tasks.get(t);if(s){s.isActive=false;this.stopTask(s)}}resume(t){const s=this.tasks.get(t);if(s){s.isActive=true;this.startTask(s)}}pauseAll(){this.tasks.forEach((t=>{t.isActive=false;this.stopTask(t)}))}resumeAll(){this.tasks.forEach((t=>{t.isActive=true;this.startTask(t)}))}getTaskStatus(t){const s=this.tasks.get(t);if(!s){return{isRegistered:false,isActive:false}}return{isRegistered:true,isActive:s.isActive&&!!s.intervalId,interval:this.getTaskInterval(s)}}getTasks(){return Array.from(this.tasks.keys())}destroy(){this.tasks.forEach((t=>this.stopTask(t)));this.tasks.clear();this.removeVisibilityHandling()}startTask(t){if(!t.isActive)return;if(!this.isDocumentVisible&&t.config.pauseOnHidden){return}const s=this.getTaskInterval(t);t.intervalId=window.setInterval((async()=>{try{await t.fn()}catch(s){console.error(`Polling task ${t.id} failed:`,s)}}),s)}stopTask(t){if(t.intervalId){clearInterval(t.intervalId);t.intervalId=undefined}}getTaskInterval(t){return this.isDocumentVisible?t.config.activeInterval:t.config.backgroundInterval}setupVisibilityHandling(){if(typeof document==="undefined")return;const t=()=>{this.isDocumentVisible=!document.hidden;if(this.isDocumentVisible){this.handleDocumentVisible()}else{this.handleDocumentHidden()}};document.addEventListener("visibilitychange",t);this.visibilityHandler=t}removeVisibilityHandling(){if(typeof document==="undefined")return;if(this.visibilityHandler){document.removeEventListener("visibilitychange",this.visibilityHandler);this.visibilityHandler=undefined}}handleDocumentVisible(){this.tasks.forEach((t=>{if(t.isActive&&t.config.pauseOnHidden){this.stopTask(t);this.startTask(t)}}))}handleDocumentHidden(){this.tasks.forEach((t=>{if(t.isActive&&t.config.pauseOnHidden){this.stopTask(t);this.startTask(t)}}))}}const E=new f;class T{constructor(){this.states=new Map;this.timers=new Map;this.listeners=new Map}startLoading(t,s,e={}){const{minLoadingTime:i=300,maxLoadingTime:n=3e4,showProgress:a=false}=e;this.clearTimers(t);const c={isLoading:true,loadingText:s,progress:a?0:undefined,error:null,lastUpdated:Date.now()};this.setState(t,c);const r={};if(i>0){r.minTimer=window.setTimeout((()=>{const s=this.states.get(t);if(s){this.setState(t,{...s})}}),i)}if(n>0){r.maxTimer=window.setTimeout((()=>{this.stopLoading(t,"Loading timeout")}),n)}this.timers.set(t,r)}updateProgress(t,s,e){const i=this.states.get(t);if(!i||!i.isLoading)return;this.setState(t,{...i,progress:Math.max(0,Math.min(100,s)),loadingText:e||i.loadingText,lastUpdated:Date.now()})}stopLoading(t,s){const e=this.states.get(t);if(!e)return;const i=this.timers.get(t);const n=i?.minTimer;if(n){const i=Date.now()-(e.lastUpdated||0);const n=300;if(i<n){setTimeout((()=>{this.completeStop(t,s)}),n-i);return}}this.completeStop(t,s)}completeStop(t,s){this.clearTimers(t);const e=this.states.get(t);if(!e)return;const i={isLoading:false,loadingText:undefined,progress:undefined,error:s||null,lastUpdated:Date.now()};this.setState(t,i);setTimeout((()=>{this.states.delete(t);this.listeners.delete(t)}),5e3)}getState(t){return this.states.get(t)||null}isLoading(t){const s=this.states.get(t);return s?.isLoading||false}subscribe(t,s){if(!this.listeners.has(t)){this.listeners.set(t,new Set)}const e=this.listeners.get(t);e.add(s);const i=this.states.get(t);if(i){s(i)}return()=>{e.delete(s);if(e.size===0){this.listeners.delete(t)}}}clearAll(){for(const t of this.states.keys()){this.clearTimers(t)}this.states.clear();this.timers.clear();this.listeners.clear()}getActiveStates(){const t={};for(const[s,e]of this.states){if(e.isLoading){t[s]=e}}return t}setState(t,s){this.states.set(t,s);const e=this.listeners.get(t);if(e){e.forEach((t=>t(s)))}}clearTimers(t){const s=this.timers.get(t);if(s){if(s.minTimer)clearTimeout(s.minTimer);if(s.maxTimer)clearTimeout(s.maxTimer);if(s.transitionTimer)clearTimeout(s.transitionTimer);this.timers.delete(t)}}destroy(){this.clearAll()}}const p=new T;class S{constructor(){this.subscriptions=new Map;this.componentSubscriptions=new Map;this.dataTypeSubscriptions=new Map;this.pollingTasks=new Map;this.loadingStates=new Map}subscribe(t,s,e={}){const i=`${t}-${s}-${Date.now()}`;const n={id:i,componentId:t,dataType:s,walletAddress:e.walletAddress,chainUID:e.chainUID,params:e,active:true,createdAt:new Date};this.subscriptions.set(i,n);if(!this.componentSubscriptions.has(t)){this.componentSubscriptions.set(t,new Set)}this.componentSubscriptions.get(t).add(i);if(!this.dataTypeSubscriptions.has(s)){this.dataTypeSubscriptions.set(s,new Set)}this.dataTypeSubscriptions.get(s).add(i);console.log(`ðŸ“Š Data subscription added: ${t} â†’ ${s}`,e);this.notifyDataNeeded(s,n);return i}unsubscribe(t){const s=this.subscriptions.get(t);if(!s)return;s.active=false;const e=this.componentSubscriptions.get(s.componentId);if(e){e.delete(t);if(e.size===0){this.componentSubscriptions.delete(s.componentId)}}const i=this.dataTypeSubscriptions.get(s.dataType);if(i){i.delete(t);if(i.size===0){this.dataTypeSubscriptions.delete(s.dataType);this.notifyDataNotNeeded(s.dataType)}}this.subscriptions.delete(t);console.log(`ðŸ“Š Data subscription removed: ${s.componentId} â†’ ${s.dataType}`)}unsubscribeComponent(t){const s=this.componentSubscriptions.get(t);if(!s)return;const e=[...s];e.forEach((t=>this.unsubscribe(t)));console.log(`ðŸ“Š All subscriptions removed for component: ${t}`)}hasSubscriptions(t,s,e){const i=this.dataTypeSubscriptions.get(t);if(!i||i.size===0)return false;if(!s&&!e)return true;for(const t of i){const i=this.subscriptions.get(t);if(!i?.active)continue;const n=!s||i.walletAddress===s;const a=!e||i.chainUID===e;if(n&&a)return true}return false}getSubscriptions(t){const s=this.dataTypeSubscriptions.get(t)||new Set;return Array.from(s).map((t=>this.subscriptions.get(t))).filter((t=>t?.active))}getComponentSubscriptions(t){const s=this.componentSubscriptions.get(t)||new Set;return Array.from(s).map((t=>this.subscriptions.get(t))).filter((t=>t?.active))}notifyDataNeeded(t,s){const e=`data-${t}`;this.loadingStates.set(t,e);p.startLoading(e,`Loading ${t}...`,{minLoadingTime:300,showProgress:true});this.setupDataPolling(t,s);const i=this.getDataNeededEvent(t);if(i){h(i,{dataType:t,subscription:s,action:"start",loadingId:e})}}notifyDataNotNeeded(t){const s=this.loadingStates.get(t);if(s){p.stopLoading(s);this.loadingStates.delete(t)}this.stopDataPolling(t);const e=this.getDataNeededEvent(t);if(e){h(e,{dataType:t,action:"stop"})}}setupDataPolling(t,s){const e=`subscription-${t}`;if(this.pollingTasks.has(t)){return}const i=this.getPollingIntervals(t);E.register(e,(async()=>{const e=`${t}-refresh`;await l.request(e,(async()=>{const e=this.getDataNeededEvent(t);if(e){h(e,{dataType:t,subscription:s,action:"refresh"})}return{success:true}}),{ttl:i.cacheTTL})}),{activeInterval:i.active,backgroundInterval:i.background,pauseOnHidden:true});this.pollingTasks.set(t,e)}stopDataPolling(t){const s=this.pollingTasks.get(t);if(s){E.unregister(s);this.pollingTasks.delete(t)}}getPollingIntervals(s){const e=t.performance;switch(s){case"balances":return{active:e.polling.active.balances,background:e.polling.background.balances,cacheTTL:e.cache.balances};case"marketData":return{active:e.polling.active.marketData,background:e.polling.background.marketData,cacheTTL:e.cache.marketData};case"tokenPrices":return{active:e.polling.active.marketData,background:e.polling.background.marketData,cacheTTL:e.cache.tokens};case"liquidityPositions":return{active:e.polling.active.marketData,background:e.polling.background.marketData,cacheTTL:e.cache.marketData};case"transactions":return{active:e.polling.active.balances,background:e.polling.background.balances,cacheTTL:e.cache.balances};case"portfolioValue":return{active:e.polling.active.balances,background:e.polling.background.balances,cacheTTL:e.cache.balances};default:return{active:e.polling.active.marketData,background:e.polling.background.marketData,cacheTTL:e.cache.marketData}}}getDataNeededEvent(t){switch(t){case"balances":return o.USER.BALANCES_REFRESH;case"transactions":return o.TRANSACTION.TRACK_REQUEST;case"liquidityPositions":return o.LIQUIDITY.POSITIONS_REFRESH;case"marketData":return o.MARKET.REFRESH_DATA;case"tokenPrices":return o.MARKET.TOKEN_DETAILS_REQUEST;case"portfolioValue":return o.USER.REFRESH_DATA;default:return null}}getStats(){const t=this.subscriptions.size;const s=Array.from(this.subscriptions.values()).filter((t=>t.active)).length;const e=this.componentSubscriptions.size;const i=this.dataTypeSubscriptions.size;const n={};for(const[t,s]of this.dataTypeSubscriptions){n[t]=s.size}return{totalSubscriptions:t,activeSubscriptions:s,componentCount:e,dataTypeCount:i,dataTypeStats:n,components:Array.from(this.componentSubscriptions.keys())}}}const m=new S;export{o as E,h as a,m as d,p as l,E as p,l as r};
//# sourceMappingURL=p-DpGAwWdH.js.map